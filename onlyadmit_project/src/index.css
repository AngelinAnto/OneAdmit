import { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { 
  ArrowLeft, MapPin, IndianRupee, Home, Award, Globe, 
  Phone, Mail, Calendar, Clock, AlertTriangle, CheckCircle,
  Loader2, GraduationCap, Gift
} from 'lucide-react';
import { Link, useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { format, parseISO, isAfter, isBefore, addHours } from 'date-fns';
import BottomNav from '@/components/ui/BottomNav';

export default function CollegeDetail() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const collegeId = new URLSearchParams(window.location.search).get('id');
  
  const [applySheetOpen, setApplySheetOpen] = useState(false);
  const [selectedCourse, setSelectedCourse] = useState('');
  const [selectedSlot, setSelectedSlot] = useState('');
  const [needsHostel, setNeedsHostel] = useState(false);
  const [needsScholarship, setNeedsScholarship] = useState(false);
  const [customAnswers, setCustomAnswers] = useState({});
  const [applying, setApplying] = useState(false);
  
  const { data: college, isLoading } = useQuery({
    queryKey: ['college', collegeId],
    queryFn: async () => {
      const colleges = await base44.entities.College.filter({ id: collegeId });
      return colleges[0];
    },
    enabled: !!collegeId,
  });

  const { data: examSlots = [] } = useQuery({
    queryKey: ['examSlots', collegeId],
    queryFn: () => base44.entities.ExamSlot.filter({ college_id: collegeId, is_active: true }),
    enabled: !!collegeId,
  });

  const { data: profile } = useQuery({
    queryKey: ['studentProfile'],
    queryFn: async () => {
      const user = await base44.auth.me();
      const profiles = await base44.entities.StudentProfile.filter({ created_by: user.email });
      return profiles[0];
    },
  });

  const { data: existingApplications = [] } = useQuery({
    queryKey: ['myApplications'],
    queryFn: async () => {
      const user = await base44.auth.me();
      return base44.entities.Application.filter({ student_email: user.email });
    },
  });

  // Check for exam slot conflicts
  const getSlotConflicts = (slotId) => {
    const slot = examSlots.find(s => s.id === slotId);
    if (!slot) return [];
    
    return existingApplications.filter(app => {
      if (!app.exam_date || app.college_id === collegeId) return false;
      
      const appDate = parseISO(app.exam_date);
      const slotDate = parseISO(slot.date);
      
      // Same day
      if (format(appDate, 'yyyy-MM-dd') === format(slotDate, 'yyyy-MM-dd')) {
        // Check time overlap (simplified - assumes 2 hour exam duration)
        const appStart = new Date(`${app.exam_date}T${app.exam_time}`);
        const appEnd = addHours(appStart, 2);
        const slotStart = new Date(`${slot.date}T${slot.start_time}`);
        const slotEnd = new Date(`${slot.date}T${slot.end_time}`);
        
        return (slotStart < appEnd && slotEnd > appStart);
      }
      return false;
    });
  };

  const hasExistingApplication = existingApplications.some(
    app => app.college_id === collegeId
  );

  const handleApply = async () => {
    if (!profile?.profile_complete) {
      toast.error('Please complete your profile first');
      navigate(createPageUrl('Profile'));
      return;
    }

    if (!selectedCourse) {
      toast.error('Please select a course');
      return;
    }

    setApplying(true);
    try {
      const user = await base44.auth.me();
      const slot = examSlots.find(s => s.id === selectedSlot);
      
      const studentName = `${profile.first_name} ${profile.middle_name || ''} ${profile.last_name}`.trim();
      const resultDate = slot?.date ? format(new Date(new Date(slot.date).getTime() + 30 * 24 * 60 * 60 * 1000), 'yyyy-MM-dd') : null;
      
      await base44.entities.Application.create({
        student_profile_id: profile.id,
        student_email: user.email,
        student_name: studentName,
        college_id: collegeId,
        college_name: college.name,
        course: selectedCourse,
        exam_slot_id: selectedSlot || null,
        exam_date: slot?.date || null,
        exam_time: slot?.start_time || null,
        result_date: resultDate,
        needs_hostel: needsHostel,
        needs_scholarship: needsScholarship,
        custom_answers: Object.entries(customAnswers).map(([q, a]) => ({ question: q, answer: a })),
        status: 'pending',
        payment_status: 'pending',
        amount_paid: college.application_fee || 0,
      });

      // Update slot booking count
      if (slot) {
        await base44.entities.ExamSlot.update(slot.id, {
          booked_seats: (slot.booked_seats || 0) + 1
        });
      }

      queryClient.invalidateQueries(['myApplications']);
      toast.success('Application submitted successfully!');
      setApplySheetOpen(false);
      navigate(createPageUrl('Applications'));
    } catch (error) {
      toast.error('Failed to submit application');
    } finally {
      setApplying(false);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 pb-24">
        <Skeleton className="h-48 w-full" />
        <div className="px-4 py-6 space-y-4">
          <Skeleton className="h-8 w-3/4" />
          <Skeleton className="h-4 w-1/2" />
          <Skeleton className="h-24 w-full rounded-xl" />
        </div>
        <BottomNav />
      </div>
    );
  }

  if (!college) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center pb-24">
        <div className="text-center">
          <h2 className="font-semibold text-gray-900">College not found</h2>
          <Link to={createPageUrl('Colleges')}>
            <Button variant="link">Back to colleges</Button>
          </Link>
        </div>
        <BottomNav />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-32">
      {/* Header */}
      <div className="relative">
        <div className="h-48 bg-gradient-to-br from-violet-500 to-indigo-600">
          {college.cover_image_url && (
            <img 
              src={college.cover_image_url} 
              alt="" 
              className="w-full h-full object-cover opacity-50"
            />
          )}
        </div>
        
        <Link 
          to={createPageUrl('Colleges')}
          className="absolute top-4 left-4 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center"
        >
          <ArrowLeft className="w-5 h-5" />
        </Link>
        
        <div className="absolute bottom-0 left-4 right-4 translate-y-1/2">
          <div className="bg-white rounded-2xl shadow-lg p-4 flex items-center gap-4">
            {college.logo_url ? (
              <img 
                src={college.logo_url} 
                alt="" 
                className="w-16 h-16 rounded-xl object-cover"
              />
            ) : (
              <div className="w-16 h-16 rounded-xl bg-gradient-to-br from-violet-500 to-indigo-500 flex items-center justify-center text-white text-2xl font-bold">
                {college.name?.charAt(0)}
              </div>
            )}
            <div className="flex-1 min-w-0">
              <h1 className="font-bold text-gray-900 text-lg truncate">{college.name}</h1>
              <p className="text-sm text-gray-500 flex items-center gap-1">
                <MapPin className="w-3 h-3" />
                {college.city}, {college.state}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div className="px-4 pt-20 space-y-4">
        {/* Badges */}
        <div className="flex flex-wrap gap-2">
          {college.accreditation && (
            <Badge className="bg-violet-100 text-violet-700">
              <Award className="w-3 h-3 mr-1" />
              {college.accreditation}
            </Badge>
          )}
          {college.ranking && (
            <Badge className="bg-indigo-100 text-indigo-700">
              NIRF #{college.ranking}
            </Badge>
          )}
          {college.has_hostel && (
            <Badge className="bg-green-100 text-green-700">
              <Home className="w-3 h-3 mr-1" />
              Hostel Available
            </Badge>
          )}
          {college.has_scholarship && (
            <Badge className="bg-amber-100 text-amber-700">
              <Gift className="w-3 h-3 mr-1" />
              Scholarship
            </Badge>
          )}
        </div>

        {/* Quick Info */}
        <div className="bg-white rounded-2xl p-4 space-y-3">
          <div className="flex justify-between items-center">
            <span className="text-gray-500">Annual Fees</span>
            <span className="font-semibold text-gray-900 flex items-center">
              <IndianRupee className="w-4 h-4" />
              {college.annual_fees_min?.toLocaleString()} - {college.annual_fees_max?.toLocaleString()}
            </span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-gray-500">Application Fee</span>
            <span className="font-semibold text-gray-900 flex items-center">
              <IndianRupee className="w-4 h-4" />
              {college.application_fee?.toLocaleString() || 'Free'}
            </span>
          </div>
          {college.application_deadline && (
            <div className="flex justify-between items-center">
              <span className="text-gray-500">Deadline</span>
              <span className="font-semibold text-red-600">
                {format(new Date(college.application_deadline), 'MMM d, yyyy')}
              </span>
            </div>
          )}
        </div>

        {/* Courses */}
        <div className="bg-white rounded-2xl p-4">
          <h3 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
            <GraduationCap className="w-5 h-5 text-violet-600" />
            Available Courses
          </h3>
          <div className="flex flex-wrap gap-2">
            {college.courses?.map((course, i) => (
              <Badge key={i} variant="secondary" className="bg-gray-100 text-gray-700 px-3 py-1">
                {course}
              </Badge>
            ))}
          </div>
        </div>

        {/* Description */}
        {college.description && (
          <div className="bg-white rounded-2xl p-4">
            <h3 className="font-semibold text-gray-900 mb-2">About</h3>
            <p className="text-gray-600 text-sm leading-relaxed">{college.description}</p>
          </div>
        )}

        {/* Contact */}
        <div className="bg-white rounded-2xl p-4 space-y-3">
          <h3 className="font-semibold text-gray-900 mb-2">Contact</h3>
          {college.website && (
            <a 
              href={college.website} 
              target="_blank" 
              rel="noopener noreferrer"
              className="flex items-center gap-2 text-violet-600"
            >
              <Globe className="w-4 h-4" />
              <span className="text-sm truncate">{college.website}</span>
            </a>
          )}
          {college.phone && (
            <a href={`tel:${college.phone}`} className="flex items-center gap-2 text-gray-700">
              <Phone className="w-4 h-4" />
              <span className="text-sm">{college.phone}</span>
            </a>
          )}
          {college.email && (
            <a href={`mailto:${college.email}`} className="flex items-center gap-2 text-gray-700">
              <Mail className="w-4 h-4" />
              <span className="text-sm">{college.email}</span>
            </a>
          )}
        </div>
      </div>

      {/* Fixed Apply Button */}
      <div className="fixed bottom-20 left-0 right-0 px-4 py-3 bg-white border-t border-gray-100">
        {hasExistingApplication ? (
          <Button disabled className="w-full h-14 rounded-2xl text-lg font-semibold bg-gray-100 text-gray-500">
            <CheckCircle className="w-5 h-5 mr-2" />
            Already Applied
          </Button>
        ) : (
          <Button 
            onClick={() => setApplySheetOpen(true)}
            className="w-full h-14 rounded-2xl text-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700"
          >
            Apply Now
            {college.application_fee > 0 && ` • ₹${college.application_fee}`}
          </Button>
        )}
      </div>

      {/* Apply Sheet */}
      <Sheet open={applySheetOpen} onOpenChange={setApplySheetOpen}>
        <SheetContent side="bottom" className="h-[85vh] rounded-t-3xl overflow-y-auto">
          <SheetHeader className="text-left pb-4">
            <SheetTitle>Apply to {college.name}</SheetTitle>
          </SheetHeader>
          
          <div className="space-y-6 pb-8">
            {/* Course Selection */}
            <div className="space-y-2">
              <Label className="text-base font-semibold">Select Course *</Label>
              <Select value={selectedCourse} onValueChange={setSelectedCourse}>
                <SelectTrigger className="h-12 rounded-xl">
                  <SelectValue placeholder="Choose a course" />
                </SelectTrigger>
                <SelectContent>
                  {college.courses?.map((course, i) => (
                    <SelectItem key={i} value={course}>{course}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Exam Slot */}
            {examSlots.length > 0 && (
              <div className="space-y-3">
                <Label className="text-base font-semibold">Select Exam Slot</Label>
                <RadioGroup value={selectedSlot} onValueChange={setSelectedSlot}>
                  {examSlots.map((slot) => {
                    const conflicts = getSlotConflicts(slot.id);
                    const isFull = slot.booked_seats >= slot.total_seats;
                    const hasConflict = conflicts.length > 0;
                    
                    return (
                      <div 
                        key={slot.id}
                        className={`relative border rounded-xl p-4 ${
                          selectedSlot === slot.id ? 'border-violet-500 bg-violet-50' : 'border-gray-200'
                        } ${(isFull || hasConflict) ? 'opacity-60' : ''}`}
                      >
                        <label className="flex items-start gap-3 cursor-pointer">
                          <RadioGroupItem 
                            value={slot.id} 
                            disabled={isFull || hasConflict}
                            className="mt-1"
                          />
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <Calendar className="w-4 h-4 text-violet-600" />
                              <span className="font-medium">
                                {format(new Date(slot.date), 'EEEE, MMM d, yyyy')}
                              </span>
                            </div>
                            <div className="flex items-center gap-2 text-sm text-gray-600">
                              <Clock className="w-3 h-3" />
                              <span>{slot.start_time} - {slot.end_time}</span>
                              {slot.venue && <span>• {slot.venue}</span>}
                            </div>
                            <div className="text-xs text-gray-500 mt-1">
                              {slot.total_seats - slot.booked_seats} seats available
                            </div>
                            
                            {hasConflict && (
                              <div className="flex items-center gap-1 text-amber-600 text-sm mt-2">
                                <AlertTriangle className="w-4 h-4" />
                                <span>Conflicts with {conflicts[0].college_name}</span>
                              </div>
                            )}
                            {isFull && (
                              <Badge variant="secondary" className="mt-2 bg-red-100 text-red-700">
                                Fully Booked
                              </Badge>
                            )}
                          </div>
                        </label>
                      </div>
                    );
                  })}
                </RadioGroup>
              </div>
            )}

            {/* Preferences */}
            <div className="space-y-3">
              <Label className="text-base font-semibold">Preferences</Label>
              {college.has_hostel && (
                <label className="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-gray-50">
                  <Checkbox
                    checked={needsHostel}
                    onCheckedChange={setNeedsHostel}
                  />
                  <div>
                    <span className="font-medium text-gray-900">Need Hostel</span>
                    {college.hostel_fees && (
                      <span className="text-sm text-gray-500 ml-2">
                        ₹{college.hostel_fees?.toLocaleString()}/year
                      </span>
                    )}
                  </div>
                </label>
              )}
              {college.has_scholarship && (
                <label className="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-gray-50">
                  <Checkbox
                    checked={needsScholarship}
                    onCheckedChange={setNeedsScholarship}
                  />
                  <div>
                    <span className="font-medium text-gray-900">Apply for Scholarship</span>
                  </div>
                </label>
              )}
            </div>

            {/* Custom Questions */}
            {college.custom_questions?.length > 0 && (
              <div className="space-y-4">
                <Label className="text-base font-semibold">Additional Questions</Label>
                {college.custom_questions.map((q, i) => (
                  <div key={i} className="space-y-2">
                    <Label>
                      {q.question} {q.required && <span className="text-red-500">*</span>}
                    </Label>
                    {q.type === 'select' ? (
                      <Select
                        value={customAnswers[q.question] || ''}
                        onValueChange={(v) => setCustomAnswers(prev => ({ ...prev, [q.question]: v }))}
                      >
                        <SelectTrigger className="h-12 rounded-xl">
                          <SelectValue placeholder="Select an option" />
                        </SelectTrigger>
                        <SelectContent>
                          {q.options?.map((opt, j) => (
                            <SelectItem key={j} value={opt}>{opt}</SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : q.type === 'checkbox' ? (
                      <label className="flex items-center gap-2">
                        <Checkbox
                          checked={customAnswers[q.question] === 'true'}
                          onCheckedChange={(v) => 
                            setCustomAnswers(prev => ({ ...prev, [q.question]: v ? 'true' : 'false' }))
                          }
                        />
                        <span className="text-sm text-gray-600">Yes</span>
                      </label>
                    ) : (
                      <Textarea
                        value={customAnswers[q.question] || ''}
                        onChange={(e) => 
                          setCustomAnswers(prev => ({ ...prev, [q.question]: e.target.value }))
                        }
                        placeholder="Your answer"
                        className="rounded-xl"
                      />
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Submit */}
            <div className="pt-4 border-t">
              <div className="flex justify-between items-center mb-4">
                <span className="text-gray-600">Application Fee</span>
                <span className="text-xl font-bold">₹{college.application_fee || 0}</span>
              </div>
              <Button 
                onClick={handleApply}
                disabled={applying || !selectedCourse}
                className="w-full h-14 rounded-2xl text-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
              >
                {applying ? (
                  <>
                    <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                    Submitting...
                  </>
                ) : (
                  'Submit Application'
                )}
              </Button>
            </div>
          </div>
        </SheetContent>
      </Sheet>

      <BottomNav />
    </div>
  );
}
