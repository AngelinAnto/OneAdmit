import { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import ProfileForm from '@/components/profile/ProfileForm';
import BottomNav from '@/components/ui/BottomNav';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { 
  User, CheckCircle, AlertCircle, LogOut, Edit2, 
  Mail, Phone, Calendar, MapPin, GraduationCap 
} from 'lucide-react';
import { format } from 'date-fns';
import { createPageUrl } from '@/utils';

export default function Profile() {
  const queryClient = useQueryClient();
  const [isEditing, setIsEditing] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
  });

  const { data: profile, isLoading } = useQuery({
    queryKey: ['studentProfile'],
    queryFn: async () => {
      const user = await base44.auth.me();
      const profiles = await base44.entities.StudentProfile.filter({ created_by: user.email });
      return profiles[0] || null;
    },
  });

  const saveMutation = useMutation({
    mutationFn: async (data) => {
      if (profile?.id) {
        return base44.entities.StudentProfile.update(profile.id, data);
      } else {
        return base44.entities.StudentProfile.create(data);
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['studentProfile']);
      setIsEditing(false);
    },
  });

  const handleLogout = () => {
    base44.auth.logout();
  };

  // Auto-show edit form if no profile exists
  useEffect(() => {
    if (!isLoading && !profile) {
      setIsEditing(true);
    }
  }, [isLoading, profile]);

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 pb-24">
        <div className="bg-white px-4 pt-12 pb-6">
          <Skeleton className="w-20 h-20 rounded-2xl mx-auto mb-4" />
          <Skeleton className="h-6 w-48 mx-auto mb-2" />
          <Skeleton className="h-4 w-32 mx-auto" />
        </div>
        <BottomNav />
      </div>
    );
  }

  if (isEditing) {
    return (
      <div className="min-h-screen bg-gray-50 pb-24">
        <div className="bg-white px-4 pt-12 pb-4 sticky top-0 z-10">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-bold text-gray-900">
              {profile ? 'Edit Profile' : 'Complete Your Profile'}
            </h1>
            {profile && (
              <Button variant="ghost" onClick={() => setIsEditing(false)}>
                Cancel
              </Button>
            )}
          </div>
          {!profile && (
            <p className="text-sm text-gray-500 mt-1">
              Fill this once and apply to any college instantly
            </p>
          )}
        </div>
        
        <div className="px-4 py-4">
          <ProfileForm 
            profile={profile || { email: user?.email, full_name: user?.full_name }} 
            onSave={saveMutation.mutateAsync}
          />
        </div>
        
        <BottomNav />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-24">
      {/* Header */}
      <div className="bg-gradient-to-br from-violet-500 to-indigo-600 px-4 pt-12 pb-20">
        <div className="flex justify-end gap-2 mb-4">
          <Button 
            variant="ghost" 
            size="sm" 
            className="text-white hover:bg-white/10"
            onClick={async () => {
              await base44.auth.updateMe({ account_type: null });
              window.location.href = createPageUrl('RoleSelection');
            }}
          >
            Switch Account
          </Button>
          <Button 
            variant="ghost" 
            size="icon" 
            className="text-white hover:bg-white/10"
            onClick={handleLogout}
          >
            <LogOut className="w-5 h-5" />
          </Button>
        </div>
        
        <div className="text-center">
          {profile?.photo_url ? (
            <img 
              src={profile.photo_url} 
              alt="" 
              className="w-24 h-24 rounded-2xl object-cover mx-auto mb-4 border-4 border-white/30"
            />
          ) : (
            <div className="w-24 h-24 rounded-2xl bg-white/20 flex items-center justify-center mx-auto mb-4">
              <User className="w-12 h-12 text-white" />
            </div>
          )}
          <h1 className="text-2xl font-bold text-white mb-1">
            {profile?.first_name ? `${profile.first_name} ${profile.middle_name || ''} ${profile.last_name}`.trim() : user?.full_name || 'Student'}
          </h1>
          <p className="text-violet-200">{user?.email}</p>
          
          {profile?.profile_complete ? (
            <Badge className="mt-3 bg-green-500/20 text-green-100 border-green-400/30">
              <CheckCircle className="w-3 h-3 mr-1" />
              Profile Complete
            </Badge>
          ) : (
            <Badge className="mt-3 bg-amber-500/20 text-amber-100 border-amber-400/30">
              <AlertCircle className="w-3 h-3 mr-1" />
              Incomplete Profile
            </Badge>
          )}
        </div>
      </div>

      {/* Profile Card */}
      <div className="px-4 -mt-12">
        <div className="bg-white rounded-2xl shadow-lg p-5 space-y-6">
          <div className="flex items-center justify-between">
            <h2 className="font-semibold text-gray-900">Profile Details</h2>
            <Button 
              variant="outline" 
              size="sm" 
              onClick={() => setIsEditing(true)}
              className="rounded-xl"
            >
              <Edit2 className="w-4 h-4 mr-1" />
              Edit
            </Button>
          </div>
          
          {/* Contact Info */}
          <div className="space-y-3">
            <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Contact</h3>
            <div className="space-y-2">
              {profile?.email && (
                <div className="flex items-center gap-3 text-gray-700">
                  <Mail className="w-4 h-4 text-gray-400" />
                  <span>{profile.email}</span>
                </div>
              )}
              {profile?.phone && (
                <div className="flex items-center gap-3 text-gray-700">
                  <Phone className="w-4 h-4 text-gray-400" />
                  <span>{profile.phone}</span>
                </div>
              )}
              {profile?.date_of_birth && (
                <div className="flex items-center gap-3 text-gray-700">
                  <Calendar className="w-4 h-4 text-gray-400" />
                  <span>{format(new Date(profile.date_of_birth), 'MMM d, yyyy')}</span>
                </div>
              )}
              {profile?.city && (
                <div className="flex items-center gap-3 text-gray-700">
                  <MapPin className="w-4 h-4 text-gray-400" />
                  <span>{profile.city}, {profile.state || 'Tamil Nadu'}</span>
                </div>
              )}
            </div>
          </div>
          
          {/* Academic Info */}
          <div className="space-y-3">
            <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Academics</h3>
            <div className="grid grid-cols-2 gap-4">
              {profile?.tenth_marks && (
                <div className="bg-gray-50 rounded-xl p-3">
                  <p className="text-sm text-gray-500">10th Marks</p>
                  <p className="text-xl font-bold text-gray-900">{profile.tenth_marks}%</p>
                </div>
              )}
              {profile?.twelfth_marks && (
                <div className="bg-gray-50 rounded-xl p-3">
                  <p className="text-sm text-gray-500">12th Marks</p>
                  <p className="text-xl font-bold text-gray-900">{profile.twelfth_marks}%</p>
                </div>
              )}
              {profile?.entrance_exam && (
                <div className="bg-gray-50 rounded-xl p-3 col-span-2">
                  <p className="text-sm text-gray-500">{profile.entrance_exam}</p>
                  <p className="text-xl font-bold text-gray-900">
                    {profile.entrance_score || 'Not provided'}
                  </p>
                </div>
              )}
            </div>
          </div>
          
          {/* Preferences */}
          <div className="space-y-3">
            <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Preferences</h3>
            <div className="flex flex-wrap gap-2">
              {profile?.needs_hostel && (
                <Badge variant="secondary" className="bg-blue-100 text-blue-700">
                  Hostel Required
                </Badge>
              )}
              {profile?.needs_scholarship && (
                <Badge variant="secondary" className="bg-amber-100 text-amber-700">
                  Scholarship Interest
                </Badge>
              )}
              {profile?.category && (
                <Badge variant="secondary" className="bg-gray-100 text-gray-700">
                  {profile.category}
                </Badge>
              )}
            </div>
          </div>
        </div>
      </div>

      <BottomNav />
    </div>
  );
}
